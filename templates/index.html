<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Transcriber</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png" />
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
      body { background: #f5f7fa; }
      .dropzone {
        border: 2px dashed #6c63ff;
        border-radius: 2rem;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .dropzone.dragover { background: #ebe9ff; }

      .conversion-container {
        display: grid;
        grid-template-columns: 1fr;
        justify-items: center;
        width: 100%;
        gap: 0;
      }
      .selected-section,
      .results-section {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.6s ease;
      }
      .selected-section {
        padding: 1rem;
        max-width: 60vw;
        width: 100%;
      }
      .results-section {
        padding: 1rem;
        display: none;
        opacity: 0;
      }
      .conversion-container.active {
        grid-template-columns: 1fr 1fr;
        justify-items: stretch;
        gap: 2rem;
      }
      .conversion-container.active .selected-section {
        max-width: none;
      }
      .conversion-container.active .results-section {
        display: block;
        opacity: 1;
      }

      /* Preview items smaller with remove button */
      .preview-item {
        position: relative;
        padding: 0.25rem;
      }
      .preview-item video,
      .preview-item img {
        max-width: 80px;
        max-height: 80px;
        border-radius: 0.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .remove-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(255,255,255,0.8);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.75rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .remove-btn:hover {
        background: rgba(255,0,0,0.8);
        color: #fff;
      }

      #selectedGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
      }

      .preview-item img,
      .preview-item video {
        width: 100%;
        height: auto;
        max-height: 100px;
      }

      /* --- Estilos globales de la tarjeta --- */
      .card-body {
        display: flex;
        flex-direction: column;
      }
      /* Contenedor del badge, para alinearlo al principio y separarlo del contenido */
      .status-badge-container {
        align-self: flex-start;  /* arriba a la izquierda */
        margin-bottom: 0.5rem;   /* separación del resto */
      }

      /* Clase común para ambos estados */
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;    /* espacio interior cómodo */
        border-radius: 9999px;       /* píldora */
        font-size: 0.875rem;         /* ligeramente más pequeño */
        font-weight: 600;            /* seminegrita */
        color: #fff;                 /* texto en blanco */
        white-space: nowrap;         /* sin saltos de línea */
        text-align: center;          /* centrado horizontal */
        min-width: 5rem;             /* no se encoja demasiado */
        box-sizing: border-box;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);  /* sombra suave */
      }

      /* Estado “Procesando” */
      .status-badge.processing {
        background-color: #e67e22;   /* naranja vivo */
      }

      /* Estado “Completado” */
      .status-badge.completed {
        background-color: #27ae60;   /* verde intenso */
      }
    </style>
  </head>
  <body>
    <main class="container-fluid py-5">
      <h1 class="mb-4 fw-bold text-center">
        <img src="/static/favicon.png" alt="logo" width="64" height="64" class="d-block mx-auto mb-2" />
        Transcriber
      </h1>
      <div id="conversionContainer" class="conversion-container">
        <div class="card selected-section" id="selectedSection">
          <div class="card-body">
            <div id="dropArea" class="dropzone mb-4">
              <p class="lead mb-0">Arrastra tus archivos aquí o haz clic para seleccionarlos</p>
              <input id="files" type="file" accept="video/*,image/*" multiple hidden />
            </div>
            <h2 class="h5 fw-semibold mb-3">Archivos seleccionados</h2>
            <div id="selectedGrid" class="d-flex flex-wrap g-2 mb-4"></div>
            <div class="row g-3 mb-4">
              <div class="col-md">
                <label class="form-label fw-semibold" for="target_format">Formato de salida</label>
                <select id="target_format" class="form-select">
                  <option value="">Selecciona un archivo primero</option>
                </select>
              </div>
              <div class="col-md">
                <label class="form-label fw-semibold" for="qualitySlider">
                  Calidad <span id="qualityValue" class="fw-bold">80</span>
                </label>
                <input id="qualitySlider" type="range" class="form-range" min="1" max="100" value="80" />
              </div>
            </div>
            <div class="d-grid">
              <button id="btnConvert" class="btn btn-primary btn-lg rounded-pill">
                <i class="bi bi-play-fill"></i> Iniciar Conversión
              </button>
            </div>
            <div id="progressArea" class="mt-4"></div>
          </div>
        </div>
        <div class="card results-section" id="resultsSection">
          <div class="card-body">
            <h2 class="h4 fw-semibold mt-0 mb-3">Resultados</h2>
            <div id="previewGrid" class="row g-4"></div>
          </div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const $ = s => document.querySelector(s);
      const filesInput = $('#files');
      const selectedGrid = $('#selectedGrid');

      filesInput.addEventListener('change', updateFormatOptions);
      document.getElementById('dropArea').addEventListener('click', () => filesInput.click());
      ['dragenter','dragover'].forEach(ev => $('#dropArea').addEventListener(ev, e => { e.preventDefault(); $('#dropArea').classList.add('dragover'); }));
      ['dragleave','drop'].forEach(ev => $('#dropArea').addEventListener(ev, e => { e.preventDefault(); $('#dropArea').classList.remove('dragover'); }));
      $('#dropArea').addEventListener('drop', e => {
        const dt = new DataTransfer();
        [...e.dataTransfer.files].forEach(f => dt.items.add(f));
        filesInput.files = dt.files;
        updateFormatOptions();
      });

      function renderSelectedPreviews() {
        selectedGrid.innerHTML = '';
        [...filesInput.files].forEach(file => {
          const wrapper = document.createElement('div');
          wrapper.className = 'preview-item';

          const url = URL.createObjectURL(file);
          const isVideo = file.type.startsWith('video');

          // Creamos el elemento media de forma dinámica
          let mediaEl;
          if (isVideo) {
            mediaEl = document.createElement('video');
            mediaEl.muted = true;
            mediaEl.autoplay = true;
            mediaEl.loop = true;
          } else {
            mediaEl = document.createElement('img');
            mediaEl.alt = 'preview';
          }
          mediaEl.src = url;

          // Revocamos la URL cuando termine de cargarse el media
          const revoke = () => URL.revokeObjectURL(url);
          if (isVideo) {
            mediaEl.addEventListener('loadeddata', revoke, { once: true });
          } else {
            mediaEl.addEventListener('load', revoke, { once: true });
          }

          // Botón de quitar
          const btn = document.createElement('button');
          btn.className = 'remove-btn';
          btn.innerHTML = '&times;';
          btn.dataset.name = file.name;
          btn.addEventListener('click', () => removeFile(file.name));

          // Montamos todo
          wrapper.appendChild(btn);
          wrapper.appendChild(mediaEl);
          selectedGrid.appendChild(wrapper);
        });
      }


      function removeFile(name) {
        const dt = new DataTransfer();
        [...filesInput.files].forEach(f => {
          if (f.name !== name) dt.items.add(f);
        });
        filesInput.files = dt.files;
        updateFormatOptions();
      }

      function updateFormatOptions() {
        const select = $('#target_format');
        select.innerHTML = '';
        if (!filesInput.files.length) {
          select.innerHTML = '<option value="">Selecciona un archivo primero</option>';
        } else {
          const first = filesInput.files[0];
          const formats = first.type.startsWith('video')
            ? ['mp4','avi','mkv','mov','wmv','flv','webm']
            : ['jpg','jpeg','png','webp','gif','bmp'];
          select.innerHTML = formats.map(f => `<option value="${f}">${f.toUpperCase()}</option>`).join('');
        }
        renderSelectedPreviews();
      }

      // Conversión y polling
      document.getElementById('btnConvert').addEventListener('click', async () => {
        if (!filesInput.files.length) return alert('Selecciona al menos un archivo.');
        const format = $('#target_format').value;
        if (!format) return alert('Selecciona el formato de salida.');
        document.getElementById('conversionContainer').classList.add('active');
        const fd = new FormData();
        [...filesInput.files].forEach(f => fd.append('files', f));
        fd.append('target_format', format);
        fd.append('quality_level', $('#qualitySlider').value);

        $('#progressArea').innerHTML = `<div class=\"progress\" role=\"progressbar\"><div class=\"progress-bar progress-bar-striped progress-bar-animated\" style=\"width:0%\"></div></div>`;
        previewGrid.innerHTML = '';

        try {
          const res = await fetch('/convert', { method: 'POST', body: fd });
          const { tasks } = await res.json();
          tasks.forEach(task => createTaskCard(task));
        } catch (err) {
          $('#progressArea').innerHTML = `<div class=\"alert alert-danger\">${err.message}</div>`;
        }
      });

      function createTaskCard({ task_id, input_file, output_file }) {
        const col = document.createElement('div');
        col.className = 'col-sm-6 col-lg-4'; col.id = `card-${task_id}`;
        col.innerHTML = `
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">${input_file}</h5>
              <p class="text-muted small mb-3">${output_file}</p>
               <div class="status-badge-container">
                <span class="status-badge processing">Procesando…</span>
               </div>
            </div>
          </div>
        `;
        $('#previewGrid').appendChild(col);
        pollStatus(task_id, output_file);
      }

      async function pollStatus(id, filename) {
        try {
          const res = await fetch(`/task_status/${id}`);
          const { status, success } = await res.json();
          const badge = document.querySelector(`#card-${id} .status-badge`);
          if (status === 'running') {
            badge.style.width = badge.style.width || '0%';
            badge.parentElement.previousElementSibling.querySelector('.progress-bar').style.width = '50%';
            setTimeout(() => pollStatus(id, filename), 2000);
          } else if (status === 'done' && success) {
            badge.className = 'status-badge completed';
            badge.textContent = 'Completado';
            showPreview(filename, id);
          } else {
            badge.className = 'badge text-bg-danger';
            badge.textContent = 'Error';
          }
        } catch (err) {
          setTimeout(() => pollStatus(id, filename), 4000);
        }
      }

      function showPreview(name, id) {
        const ext = name.split('.').pop().toLowerCase();
        const src = `/converted/${encodeURIComponent(name)}`;
        const container = document.querySelector(`#card-${id} .card`);
        const mediaHtml = ['mp4','webm','mov','mkv','avi'].includes(ext)
          ? `<video class=\"w-100 mt-3 rounded\" controls src=\"${src}\"></video>`
          : `<img class=\"w-100 mt-3 rounded\" src=\"${src}\" alt=\"preview\" />`;
        container.insertAdjacentHTML('beforeend', mediaHtml);
      }
    </script>
  </body>
</html>
